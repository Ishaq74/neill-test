---
import Layout from '@layouts/Layout.astro';
import db from '@lib/db';
import type { Service } from '../../types/Service';
import type { Formation } from '../../types/Formation';
const url = new URL(Astro.request.url);
const serviceSlug = url.searchParams.get('service');
const formationSlug = url.searchParams.get('formation');
let service: Service | null = null;
let formation: Formation | null = null;
if (serviceSlug) {
  service = db.prepare('SELECT * FROM services WHERE slug = ?').get(serviceSlug) as Service;
}
if (formationSlug) {
  formation = db.prepare('SELECT * FROM formations WHERE slug = ?').get(formationSlug) as Formation;
}
---
<Layout>
  <section class="container mx-auto py-12">
    <div class="max-w-2xl mx-auto">
      <h1 class="text-3xl font-bold mb-6 text-pink-700 text-center">
        {service ? `Réserver le service : ${service.nom}` : formation ? `Inscription à la formation : ${formation.titre}` : 'Réserver une prestation'}
      </h1>
      {(service || formation) && (
        <div class="bg-pink-50 rounded-xl shadow p-6 mb-8 flex gap-6 items-center">
          <img src={service?.image || formation?.image} alt={service?.nom || formation?.titre} class="w-32 h-32 object-cover rounded-xl border-2 border-pink-200" loading="lazy" />
          <div>
            <div class="font-bold text-lg text-pink-700 mb-1">{service?.nom || formation?.titre}</div>
            <div class="text-gray-600 mb-1">{service?.categorie || formation?.categorie}</div>
            <div class="text-gray-700 mb-2 line-clamp-2">{service?.description || formation?.description}</div>
            <div class="font-bold text-pink-700 text-xl">{service?.prix || formation?.prix} €</div>
          </div>
        </div>
      )}
      <form id="reservation-form" class="bg-white rounded shadow p-8 flex flex-col gap-4" on:submit|preventDefault={async (e: SubmitEvent) => {
        const form = e.target as HTMLFormElement;
        const submitBtn = form.querySelector('button[type=submit]') as HTMLButtonElement;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Envoi en cours...';
        const data = {
          userId: (form.elements.namedItem('userId') as HTMLInputElement)?.value,
          serviceId: service ? service.id : null,
          formationId: formation ? formation.id : null,
          date: (form.elements.namedItem('date') as HTMLInputElement)?.value,
          time: (form.elements.namedItem('time') as HTMLInputElement)?.value,
          status: 'pending',
          notes: (form.elements.namedItem('notes') as HTMLInputElement)?.value
        };
        const res = await fetch('/api/reservation-db', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) {
          const result = await res.json();
          window.location.href = `/reservations/confirmation?id=${result.id}`;
        } else {
          alert('Erreur lors de la réservation.');
        }
        submitBtn.disabled = false;
        submitBtn.textContent = service ? 'Valider la réservation' : 'Valider l’inscription';
      }}>
        <label class="font-semibold">Votre nom (obligatoire)
          <input type="text" name="userId" required class="input input-bordered w-full" placeholder="Votre nom complet" />
        </label>
        <label class="font-semibold">Date souhaitée
          <input type="date" name="date" required class="input input-bordered w-full" min={new Date().toISOString().split('T')[0]} />
        </label>
        <label class="font-semibold">Heure souhaitée
          <input type="time" name="time" required class="input input-bordered w-full" />
        </label>
        <label class="font-semibold">Notes complémentaires
          <textarea name="notes" class="input input-bordered w-full" placeholder="Précisez un besoin, une allergie, etc."></textarea>
        </label>
        <button type="submit" class="bg-pink-700 text-white px-6 py-3 rounded hover:bg-pink-800 transition">{service ? 'Valider la réservation' : 'Valider l’inscription'}</button>
        <div id="reservation-success" style="display:none" class="bg-green-100 text-green-800 p-4 rounded mt-4 text-center font-semibold">Votre réservation a bien été enregistrée ! Vous recevrez une confirmation par email.</div>
      </form>
    </div>
  </section>
</Layout>
